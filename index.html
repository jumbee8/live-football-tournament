<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Focitorna élő eredmények</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body {margin:0; font-family:sans-serif; background:linear-gradient(rgba(0,0,0,0.45),rgba(0,0,0,0.45)), url('https://upload.wikimedia.org/wikipedia/commons/c/c1/Flag_of_Hungary.svg') center/cover no-repeat, url('https://images.unsplash.com/photo-1505842465776-3d0a7d6f66c8?auto=format&fit=crop&w=1600&q=60') center/cover no-repeat; color:white;}
  header{display:flex; justify-content:space-between; padding:12px; align-items:center; flex-wrap:wrap;}
  header h1{margin:0; font-size:20px;}
  header button{padding:6px 10px; border:none; border-radius:6px; cursor:pointer; background:#2b8a3e; color:white; margin-left:4px;}
  main{display:grid; grid-template-columns:380px 1fr; gap:12px; max-width:1200px; margin:12px auto;}
  .panel{background:rgba(0,0,0,0.55); padding:12px; border-radius:10px;}
  .section{margin-bottom:12px;}
  input, textarea, select{width:100%; padding:6px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:white; outline:none; box-sizing:border-box;}
  .btn{padding:6px 10px; border:none; border-radius:6px; background:#2b8a3e; color:white; cursor:pointer; margin-top:4px;}
  .btn.secondary{background:rgba(255,255,255,0.08);}
  .btn.danger{background:#b33;}
  .workspace{background:rgba(0,0,0,0.35); padding:12px; border-radius:10px; min-height:400px;}
  table{width:100%; border-collapse:collapse; color:white; margin-bottom:6px;}
  th,td{border:1px solid rgba(255,255,255,0.06); padding:4px; text-align:center; font-size:13px;}
  th{background:rgba(255,255,255,0.03);}
  .readonly{border:none; background:transparent; color:white; width:48px; text-align:center;}
  @media(max-width:900px){main{grid-template-columns:1fr;}}
</style>
</head>
<body>
<header>
<h1>Focitorna Élő Eredmények</h1>
<div id="topButtons">
<span id="userArea">Néző módban</span>
<button id="btnLogin">Bejelentkezés/Regisztráció</button>
<button id="btnExport">PDF export</button>
</div>
</header>
<main>
<aside class="panel" id="editorPanel">
  <div class="section">
    <h3>Admin belépés</h3>
    <label>Felhasználó:</label><input id="authUser" type="text">
    <label>Jelszó:</label><input id="authPass" type="password">
    <div style="display:flex; gap:4px; margin-top:6px;">
      <button class="btn small" onclick="doRegister()">Regisztráció</button>
      <button class="btn small" onclick="doLogin()">Belépés</button>
      <button class="btn small secondary" onclick="doLogout()" id="btnLogout" style="display:none;">Kijelentkezés</button>
    </div>
    <div id="authMsg" style="margin-top:6px; color:#aaa; font-size:13px;"></div>
  </div>

  <hr style="border:none; height:1px; background:rgba(255,255,255,0.1); margin:8px 0;">

  <div class="section">
    <h3>Csapatok</h3>
    <label>Új csapat hozzáadása</label>
    <input id="newTeam" type="text" placeholder="Csapat neve">
    <button class="btn" onclick="addTeam()">Hozzáad</button>
    <label>Csapatlista (sorrend számít automatikus sorsolásnál)</label>
    <textarea id="teamListArea" rows="4"></textarea>
    <div style="display:flex; gap:4px; margin-top:4px;">
      <button class="btn small" onclick="loadTeamsFromTextarea()">Importál</button>
      <button class="btn small secondary" onclick="exportTeamsToTextarea()">Exportál</button>
      <button class="btn small danger" onclick="clearTeams()">Töröl</button>
    </div>
  </div>

  <div class="section">
    <h3>Csoportok</h3>
    <label>Módszer</label>
    <select id="groupMode" onchange="updateGroupMode()">
      <option value="auto">Automatikus</option>
      <option value="manual">Kézi</option>
    </select>
    <div id="autoOptions">
      <label>Csoport szám vagy csapat/csoport</label>
      <select id="autoType" onchange="updateAutoUI()">
        <option value="byGroups">Csoportok száma</option>
        <option value="bySize">Csapat/csoport</option>
      </select>
      <input id="autoNumber" type="number" min="1" value="2">
      <button class="btn" onclick="generateGroupsAuto()">Csoportok létrehozása</button>
      <button class="btn secondary" onclick="shuffleTeams()">Megkever</button>
    </div>
    <div id="manualOptions" style="display:none;">
      <label>Kézi csoport (pl. A:Fradi,Újpest)</label>
      <textarea id="manualGroups" rows="3"></textarea>
      <button class="btn" onclick="applyManualGroups()">Alkalmaz</button>
    </div>
    <label><input type="checkbox" id="autoAdvance" checked> Az első 2 automatikusan továbbjut</label>
  </div>

  <div class="section">
    <h3>Export</h3>
    <button class="btn" onclick="exportCSV()">Export CSV</button>
    <button class="btn" onclick="exportPDF()">Export PDF</button>
  </div>
</aside>

<section class="workspace" id="workspace">
  <div id="liveArea">
    <h2>Csoportok és meccsek</h2>
    <div id="groupsContainer" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:8px;"></div>
    <h2>Kieséses szakasz</h2>
    <div id="knockoutArea"></div>
  </div>
</section>
</main>

<script>
let db={teams:[],groups:{},matches:{},knockout:[],settings:{autoAdvance:true}},currentUser=null,editMode=false,viewerOnly=true;
function doRegister(){const u=document.getElementById("authUser").value.trim(),p=document.getElementById("authPass").value;if(u.length<3||p.length<3)return showAuthMsg("Legalább 3 karakter!");if(localStorage.getItem("foci_user_"+u))return showAuthMsg("Felhasználó létezik.");localStorage.setItem("foci_user_"+u,p);showAuthMsg("Regisztráció sikeres — lépj be.");}
function doLogin(){const u=document.getElementById("authUser").value.trim(),p=document.getElementById("authPass").value,stored=localStorage.getItem("foci_user_"+u);if(stored&&stored===p){localStorage.setItem("foci_logged",u);currentUser=u;showAuthMsg("Belépve: "+u);applyAuthState()}else showAuthMsg("Hibás adatok.");}
function doLogout(){localStorage.removeItem("foci_logged");currentUser=null;applyAuthState();}
function showAuthMsg(msg){document.getElementById("authMsg").innerText=msg;setTimeout(()=>{document.getElementById("authMsg").innerText=""},3000);}
function applyAuthState(){const ua=document.getElementById("userArea");const btnLogout=document.getElementById("btnLogout");if(localStorage.getItem("foci_logged")){currentUser=localStorage.getItem("foci_logged");ua.innerText="Bejelentkezve: "+currentUser;btnLogout.style.display="inline-block";document.getElementById("btnLogin").style.display="none";editMode=true;viewerOnly=false}else{currentUser=null;ua.innerText="Néző módban";btnLogout.style.display="none";document.getElementById("btnLogin").style.display="inline-block";editMode=false;viewerOnly=true;}renderViewer();}
applyAuthState();

function requireAdmin(){if(!currentUser){alert("Csak admin szerkeszthet!");return false;}return true;}

function addTeam(){if(!requireAdmin())return;const t=document.getElementById("newTeam").value.trim();if(!t)return alert("Írj be egy csapatnevet.");if(db.teams.includes(t))return alert("Ez a csapat már szerepel.");db.teams.push(t);refreshTeamsUI();saveState();}
function loadTeamsFromTextarea(){if(!requireAdmin())return;const txt=document.getElementById("teamListArea").value.trim();if(!txt)return alert("Írj be csapatokat!");const items=txt.split(/\n|,/).map(s=>s.trim()).filter(Boolean);db.teams=items;refreshTeamsUI();saveState();}
function exportTeamsToTextarea(){document.getElementById("teamListArea").value=db.teams.join(", ");}
function clearTeams(){if(!requireAdmin())return;if(!confirm("Törölni szeretnéd az összes csapatot?"))return;db.teams=[];db.groups={};db.matches={};db.knockout=[];refreshTeamsUI();saveState();}
function refreshTeamsUI(){document.getElementById("groupsContainer");exportTeamsToTextarea();}

function updateGroupMode(){const mode=document.getElementById("groupMode").value;document.getElementById("autoOptions").style.display=mode==="auto"?"block":"none";document.getElementById("manualOptions").style.display=mode==="manual"?"block":"none";}
function updateAutoUI(){}
function shuffleTeams(){if(!requireAdmin())return;db.teams=db.teams.sort(()=>Math.random()-0.5);refreshTeamsUI();}
function generateGroupsAuto(){if(!requireAdmin())return;if(db.teams.length<2)return alert("Adj meg legalább 2 csapatot.");const autoType=document.getElementById("autoType").value,num=parseInt(document.getElementById("autoNumber").value)||2;let groupCount=1;if(autoType==="byGroups"){groupCount=Math.max(1,Math.floor(num))}else{const size=Math.max(1,Math.floor(num));groupCount=Math.ceil(db.teams.length/size);}const groups={};for(let i=0;i<groupCount;i++)groups[String.fromCharCode(65+i)]=[];let idx=0;for(const t of db.teams){const gKey=String.fromCharCode(65+(idx%groupCount));groups[gKey].push(t);idx++;}const finalG={};Object.keys(groups).forEach(k=>finalG["Csoport "+k]=groups[k]);db.groups=finalG;db.matches={};db.knockout=[];saveState();renderViewer();}
function applyManualGroups(){if(!requireAdmin())return;const txt=document.getElementById("manualGroups").value.trim();if(!txt)return alert("Írj be kézi csoportokat.");const lines=txt.split("\n");const g={};for(const line of lines){const parts=line.split(":");if(parts.length<2)continue;const name=parts[0].trim();const teams=parts[1].split(",").map(s=>s.trim()).filter(Boolean);if(teams.length)g[name]=teams;}db.groups=g;db.matches={};db.knockout=[];saveState();renderViewer();}
function ensureGroupMatches(){for(const g in db.groups){const arr=db.groups[g];for(let i=0;i<arr.length;i++){for(let j=i+1;j<arr.length;j++){const key=`${g}_${i}_${j}`;if(!db.matches[key])db.matches[key]=["",""]}}}}
function saveMatch(g,i,j,h,v){if(!requireAdmin())return;const key=`${g}_${i}_${j}`;db.matches[key]=[String(h),String(v)];saveState();renderViewer();}
function calcTable(gName){const teams=db.groups[gName]||[];const stats={};teams.forEach(t=>stats[t]={played:0,points:0,goalsFor:0,goalsAgainst:0,gd:0});for(let i=0;i<teams.length;i++){for(let j=i+1;j<teams.length;j++){const key=`${gName}_${i}_${j}`,sc=db.matches[key]||["",""],a=sc[0]===""?null:parseInt(sc[0],10),b=sc[1]===""?null:parseInt(sc[1],10);if(a===null||b===null)continue;const t1=teams[i],t2=teams[j];stats[t1].played++;stats[t2].played++;stats[t1].goalsFor+=a;stats[t1].goalsAgainst+=b;stats[t2].goalsFor+=b;stats[t2].goalsAgainst+=a;if(a>b){stats[t1].points+=3}else if(a<b){stats[t2].points+=3}else{stats[t1].points++;stats[t2].points++;}}}Object.keys(stats).forEach(t=>stats[t].gd=stats[t].goalsFor-stats[t].goalsAgainst);return stats;}
function generateKnockoutIfNeeded(){db.knockout=[];if(!document.getElementById("autoAdvance").checked)return;const adv=[];for(const g in db.groups){const stats=calcTable(g);const arr=Object.keys(stats).map(t=>({team:t,...stats[t]}));arr.sort((a,b)=>{if(b.points!==a.points)return b.points-a.points;if(b.gd!==a.gd)return b.gd-a.gd;return b.goalsFor-a.goalsFor});if(arr[0])adv.push(arr[0].team);if(arr[1])adv.push(arr[1].team);}if(adv.length<4)return;const m1={team1:adv[0],team2:adv[3],score1:"",score2:""};const m2={team1:adv[2],team2:adv[1],score1:"",score2:""};db.knockout=[m1,m2];saveState();}
function renderViewer(){refreshTeamsUI();ensureGroupMatches();generateKnockoutIfNeeded();const container=document.getElementById("groupsContainer");container.innerHTML="";for(const g in db.groups){const card=document.createElement("div");card.style.background="rgba(255,255,255,0.02)";card.style.padding="6px";card.style.borderRadius="6px";card.style.marginBottom="6px";card.innerHTML=`<h3>${g}</h3>`;const teams=db.groups[g];let html=`<table><thead><tr><th>Hazai</th><th></th><th>Vendég</th><th>Eredmény</th></tr></thead><tbody>`;for(let i=0;i<teams.length;i++){for(let j=i+1;j<teams.length;j++){const key=`${g}_${i}_${j}`,sc=db.matches[key]||["",""];if(!viewerOnly){html+=`<tr><td>${teams[i]}</td><td>vs</td><td>${teams[j]}</td><td><input type="number" min="0" value="${sc[0]}" id="${key}_h" style="width:48px;" oninput="saveMatch('${g}',${i},${j},this.value,document.getElementById('${key}_v').value)"> : <input type="number" min="0" value="${sc[1]}" id="${key}_v" style="width:48px;" oninput="saveMatch('${g}',${i},${j},document.getElementById('${key}_h').value,this.value)"></td></tr>`;}else{html+=`<tr><td>${teams[i]}</td><td>vs</td><td>${teams[j]}</td><td><input class="readonly" value="${sc[0]||''}" readonly> : <input class="readonly" value="${sc[1]||''}" readonly></td></tr>`;}}}html+="</tbody></table>";const stats=calcTable(g);const rows=Object.keys(stats).map(t=>({team:t,...stats[t]}));rows.sort((a,b)=>{if(b.points!==a.points)return b.points-a.points;if(b.gd!==a.gd)return b.gd-a.gd;return b.goalsFor-a.goalsFor;});html+=`<h4>Tabella</h4><table><thead><tr><th>Csapat</th><th>P</th><th>Gy</th><th>D</th><th>V</th><th>GF</th><th>GA</th><th>GK</th></tr></thead><tbody>`;for(const r of rows)html+=`<tr><td>${r.team}</td><td>${r.played}</td><td>${Math.floor(r.points/3)}</td><td>${r.points%3}</td><td>0</td><td>${r.goalsFor}</td><td>${r.goalsAgainst}</td><td>${r.gd}</td></tr>`;html+="</tbody></table>";container.appendChild(card);card.querySelector("div")?.remove();card.innerHTML=html;}
function exportCSV(){let csv="";for(const g in db.groups){csv+=g+"\n";const teams=db.groups[g];for(let i=0;i<teams.length;i++){for(let j=i+1;j<teams.length;j++){const key=`${g}_${i}_${j}`;const sc=db.matches[key]||["",""];csv+=`${teams[i]} vs ${teams[j]} : ${sc[0]}-${sc[1]}\n`;}}csv+="\n";}downloadFile("torna.csv",csv);}
function exportPDF(){html2canvas(document.getElementById("workspace")).then(canvas=>{const imgData=canvas.toDataURL("image/png");const { jsPDF } = window.jspdf;const pdf=new jsPDF('p','mm','a4');const w=210,h=canvas.height*210/canvas.width;pdf.addImage(imgData,'PNG',0,0,w,h);pdf.save("torna.pdf");});}
function downloadFile(filename, text){const a=document.createElement("a");a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text);a.download=filename;a.click();}
function saveState(){localStorage.setItem("foci_db",JSON.stringify(db));}
function loadState(){const st=localStorage.getItem("foci_db");if(st)db=JSON.parse(st);}loadState();
</script>
</body>
</html>
